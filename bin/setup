#!/usr/bin/env bash

set -euo pipefail

VERBOSE=false
VERY_VERBOSE=false

while [[ $# -gt 0 ]]; do
  case "$1" in
    -v | --verbose)
      VERBOSE=true
      shift
      ;;
    -vv | --very-verbose)
      VERY_VERBOSE=true
      VERBOSE=true
      shift
      ;;
    -h | --help)
      echo "Usage: $0 [-v|--verbose] [-vv|--very-verbose]"
      echo "  -v, --verbose       Enable verbose output"
      echo "  -vv, --very-verbose Enable very verbose output (debug mode)"
      exit 0
      ;;
    *)
      shift
      ;;
  esac
done

export VERBOSE
export VERY_VERBOSE

GREEN="\033[0;32m"
RESET="\033[0m"

BANNER=$(
  cat <<'EOF'
   ____   ___ _____ _____ ___ _     _____ ____
  |  _ \ / _ \_   _|  ___|_ _| |   | ____/ ___|
  | | | | | | || | | |_   | || |   |  _| \___ \
 _| |_| | |_| || | |  _|  | || |___| |___ ___) |
(_)____/ \___/ |_| |_|   |___|_____|_____|____/
EOF
)

echo ""
echo -e "${GREEN}${BANNER}${RESET}"
echo ""

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

source "$PROJECT_ROOT/lib/log.sh"
source "$PROJECT_ROOT/lib/print.sh"
source "$PROJECT_ROOT/lib/prompt.sh"

OS="$(uname -s)"

if [[ "$VERY_VERBOSE" == true ]]; then
  log_set_level debug
  log_enable_timestamps
elif [[ "$VERBOSE" == true ]]; then
  log_set_level debug
fi

if [[ "$OS" == "Linux" && -f /etc/os-release ]]; then
  source /etc/os-release
  DISTRO="$ID"
  VERSION="$VERSION_ID"
else
  DISTRO=""
  VERSION=""
fi

print_key_value "OS" "$OS ($DISTRO $VERSION)"

case "$OS" in
  Linux*)
    if [[ -f /etc/os-release ]]; then
      source /etc/os-release
      if [[ "$ID" == "ubuntu" && "$VERSION_ID" == "24.04" ]]; then
        if [[ -f "$PROJECT_ROOT/bin/setup-ubuntu.sh" ]]; then
          source "$PROJECT_ROOT/bin/setup-ubuntu.sh"
        else
          log_fatal "setup-ubuntu.sh not found" 1
        fi
      else
        log_fatal "Unsupported distro: $ID $VERSION" 1
      fi
    else
      log_fatal "/etc/os-release not found" 1
    fi
    ;;
  Darwin*)
    if [[ -f "$PROJECT_ROOT/bin/setup-macos.sh" ]]; then
      source "$PROJECT_ROOT/bin/setup-macos.sh"
    else
      log_fatal "setup-macos.sh not found" 1
    fi
    ;;
  *)
    log_fatal "Unsupported OS: $OS" 1
    ;;
esac
