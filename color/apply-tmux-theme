#!/usr/bin/env python3

import os
import re
import sys
import tempfile

if len(sys.argv) < 3:
    print(f"Usage: {sys.argv[0]} <color-scheme.yaml> <.tmux.conf>", file=sys.stderr)
    sys.exit(1)

yaml_file = sys.argv[1]
tmux_file = sys.argv[2]

# Parse hex: section from YAML
colors = {}
in_hex = False
with open(yaml_file) as f:
    for line in f:
        if line.strip() == "hex:":
            in_hex = True
            continue
        if in_hex:
            if line and not line.startswith(" "):
                break
            m = re.match(r'^\s+(\w+):\s+"(#[0-9a-fA-F]+)"', line)
            if m:
                colors[m.group(1)] = m.group(2).lower()

if not colors:
    print("No hex: section found in YAML", file=sys.stderr)
    sys.exit(1)

# tmux theme variable â†’ YAML color name
thm_vars = {
    "@thm_bg": "background",  # status bar / pane background
    "@thm_fg": "foreground",  # default text
    "@thm_red": "red",  # urgent: prefix active, battery low, offline
    "@thm_green": "green",  # ok: session name, staging
    "@thm_yellow": "yellow",  # accent: current window, zoom, last window
    "@thm_blue": "blue",  # path, date/time
    "@thm_magenta": "magenta",  # battery, online status
    "@thm_dim": "brightBlack",  # inactive window labels
    "@thm_overlay_0": "brightBlack",  # separators and active pane border
    "@thm_surface_0": "brightBlack",  # inactive pane border
}

with open(tmux_file) as f:
    content = f.read()

for var, yaml_name in thm_vars.items():
    new_hex = colors[yaml_name]
    content = re.sub(
        rf'(set -g {re.escape(var)} )"#[0-9a-fA-F]{{6}}"',
        rf'\g<1>"{new_hex}"',
        content,
    )

dir_ = os.path.dirname(os.path.abspath(tmux_file))
with tempfile.NamedTemporaryFile(
    mode="w", dir=dir_, delete=False, suffix=".tmp", encoding="utf-8"
) as tmp:
    tmp_path = tmp.name
    tmp.write(content)
os.replace(tmp_path, tmux_file)
print(f"Updated {tmux_file}")
