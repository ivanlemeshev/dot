#!/usr/bin/env bash

set -euo pipefail

YAML="${1:-color-scheme.yaml}"
JSON="${2:-../windows/terminal/settings.json}"
PLIST="${3:-../macos/iterm2/com.googlecode.iterm2.plist}"
ITERMCOLORS="${4:-$(dirname "$PLIST")/custom-dark.itermcolors}"

if [[ ! -f "$YAML" || ! -f "$JSON" ]]; then
  echo "Usage: $0 <color-scheme.yaml> <settings.json> [com.googlecode.iterm2.plist] [custom-dark.itermcolors]" >&2
  exit 1
fi

# Extract hex value for a key within the hex: section
get_hex() {
  local key="$1"
  awk -v key="$key" '
    /^hex:/ { in_hex=1; next }
    in_hex && /^[^ ]/ { in_hex=0 }
    in_hex && $1 == key ":" {
      match($0, /#[0-9a-fA-F]+/)
      print substr($0, RSTART, RLENGTH)
      exit
    }
  ' "$YAML"
}

color_names=(
  foreground background
  black red green yellow blue magenta cyan white
  brightBlack brightRed brightGreen brightYellow
  brightBlue brightMagenta brightCyan brightWhite
)

# Map YAML color name to Windows Terminal JSON key
json_key() {
  case "$1" in
    magenta)       echo purple ;;
    brightMagenta) echo brightPurple ;;
    *)             echo "$1" ;;
  esac
}

TMP=$(mktemp)
trap 'rm -f "$TMP"' EXIT

jq_args=()
jq_filter='.'

for name in "${color_names[@]}"; do
  hex=$(get_hex "$name")
  key=$(json_key "$name")
  jq_args+=(--arg "$key" "${hex^^}")
  jq_filter+=" | .schemes[0].${key} = \$${key}"
done

cursor_hex=$(get_hex "white")
jq_args+=(--arg cursorColor "${cursor_hex^^}")
jq_filter+=" | .schemes[0].cursorColor = \$cursorColor"

selection_hex=$(get_hex "brightBlack")
jq_args+=(--arg selectionBackground "${selection_hex^^}")
jq_filter+=" | .schemes[0].selectionBackground = \$selectionBackground"

bg_hex=$(get_hex "background")
jq_args+=(--arg tabBg "${bg_hex^^}FF")
jq_filter+=" | .themes[0].tab.background = \$tabBg"
jq_filter+=" | .themes[0].tabRow.background = \$tabBg"
jq_filter+=" | .themes[0].tabRow.unfocusedBackground = \$tabBg"

jq "${jq_args[@]}" "$jq_filter" "$JSON" > "$TMP"
mv "$TMP" "$JSON"
echo "Updated $JSON"

if [[ -f "$PLIST" ]]; then
  python3 - "$YAML" "$PLIST" "$ITERMCOLORS" <<'PYEOF'
import sys, plistlib, os, tempfile

yaml_file = sys.argv[1]
plist_file = sys.argv[2]

# Parse iterm2: section from YAML
colors = {}
in_iterm2 = False
in_colors = False
current_color = None

with open(yaml_file) as f:
  for line in f:
    line = line.rstrip('\n')
    if not in_iterm2:
      if line == 'iterm2:':
        in_iterm2 = True
      continue
    if line and not line.startswith(' '):
      break
    stripped = line.lstrip()
    if not stripped or ':' not in stripped:
      continue
    indent = len(line) - len(stripped)
    key, _, val = stripped.partition(':')
    key = key.strip()
    val = val.strip()
    if indent == 2:
      if key == 'colors':
        in_colors = True
        current_color = None
      elif not val:
        current_color = key
        colors[current_color] = {}
    elif indent == 4:
      if in_colors and not val:
        current_color = key
        colors[current_color] = {}
      elif key in ('r', 'g', 'b') and current_color:
        colors[current_color][key] = float(val)
    elif indent == 6:
      if key in ('r', 'g', 'b') and current_color:
        colors[current_color][key] = float(val)

if not colors:
  print("No iterm2: section found in YAML; run extend-color-scheme first", file=sys.stderr)
  sys.exit(1)

ansi_map = [
  'black', 'red', 'green', 'yellow', 'blue', 'magenta', 'cyan', 'white',
  'brightBlack', 'brightRed', 'brightGreen', 'brightYellow',
  'brightBlue', 'brightMagenta', 'brightCyan', 'brightWhite',
]

def color_dict(name, alpha=1):
  c = colors[name]
  return {
    'Color Space': 'sRGB',
    'Alpha Component': alpha,
    'Red Component': c['r'],
    'Green Component': c['g'],
    'Blue Component': c['b'],
  }

with open(plist_file, 'rb') as f:
  pl = plistlib.load(f)

# Update Custom Color Presets > custom-dark
preset = pl['Custom Color Presets']['custom-dark']
for i, name in enumerate(ansi_map):
  preset[f'Ansi {i} Color'] = color_dict(name)
preset['Background Color'] = color_dict('background')
preset['Foreground Color'] = color_dict('foreground')
preset['Bold Color'] = color_dict('foreground')
preset['Cursor Color'] = color_dict('foreground')
preset['Cursor Guide Color'] = color_dict('foreground', alpha=0.07)
preset['Cursor Text Color'] = color_dict('background')
preset['Selected Text Color'] = color_dict('foreground')
preset['Selection Color'] = color_dict('brightBlack')
preset['Link Color'] = color_dict('blue')

# Update New Bookmarks[0] (Dark) color variants
bookmark = pl['New Bookmarks'][0]
for i, name in enumerate(ansi_map):
  bookmark[f'Ansi {i} Color (Dark)'] = color_dict(name)
bookmark['Background Color (Dark)'] = color_dict('background')
bookmark['Foreground Color (Dark)'] = color_dict('foreground')
bookmark['Bold Color (Dark)'] = color_dict('foreground')
bookmark['Cursor Color (Dark)'] = color_dict('foreground')
bookmark['Cursor Guide Color (Dark)'] = color_dict('foreground', alpha=0.07)
bookmark['Cursor Text Color (Dark)'] = color_dict('background')
bookmark['Selected Text Color (Dark)'] = color_dict('foreground')
bookmark['Selection Color (Dark)'] = color_dict('brightBlack')
bookmark['Link Color (Dark)'] = color_dict('blue')
bookmark['Badge Color (Dark)'] = color_dict('red', alpha=0.5)
bookmark['Match Background Color (Dark)'] = color_dict('yellow')

dir_ = os.path.dirname(os.path.abspath(plist_file))
with tempfile.NamedTemporaryFile(mode='wb', dir=dir_, delete=False, suffix='.tmp') as tmp:
  tmp_path = tmp.name
  plistlib.dump(pl, tmp, fmt=plistlib.FMT_XML)
os.replace(tmp_path, plist_file)
print(f"Updated {plist_file}")

# Generate custom-dark.itermcolors
def itermcolor(name):
  c = colors[name]
  return {
    'Blue Component': c['b'],
    'Color Space': 'sRGB',
    'Green Component': c['g'],
    'Red Component': c['r'],
  }

itermcolors_pl = {}
for i, name in enumerate(ansi_map):
  itermcolors_pl[f'Ansi {i} Color'] = itermcolor(name)
itermcolors_pl['Background Color'] = itermcolor('background')
itermcolors_pl['Bold Color'] = itermcolor('foreground')
itermcolors_pl['Cursor Color'] = itermcolor('foreground')
itermcolors_pl['Cursor Text Color'] = itermcolor('background')
itermcolors_pl['Foreground Color'] = itermcolor('foreground')
itermcolors_pl['Selected Text Color'] = itermcolor('foreground')
itermcolors_pl['Selection Color'] = itermcolor('background')

itermcolors_file = sys.argv[3]
itermcolors_dir = os.path.dirname(os.path.abspath(itermcolors_file))
with tempfile.NamedTemporaryFile(mode='wb', dir=itermcolors_dir, delete=False, suffix='.tmp') as tmp:
  tmp_path = tmp.name
  plistlib.dump(itermcolors_pl, tmp, fmt=plistlib.FMT_XML)
os.replace(tmp_path, itermcolors_file)
print(f"Updated {itermcolors_file}")
PYEOF
fi
